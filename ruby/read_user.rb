require 'json'
require 'pp'
require 'net/http'
require 'mongo'
require 'net/http'
require 'uri'
require 'nokogiri'
require 'time'
require 'optparse'

URI_USERS = "http://api.openstreetmap.org/api/0.6/user/"
#USERS = [5974, 147211, 29632, 55724, 33103, 36080, 226760, 109294, 18141, 202774, 30854, 6389, 5735, 18069, 223439, 57645, 73889, 13363, 4671, 27099, 51722, 55777, 81244, 119313, 2164, 109362, 28748, 85314, 77446, 69628, 61217, 57054, 1295, 69966, 17306, 2407, 1267, 63969, 122607, 28775, 66160, 49111, 38648, 150272, 117927, 219591, 201359, 143, 3114, 42938, 222391, 60234, 42537, 33217, 43766, 85853, 59758, 4559, 83544, 33705, 47355, 12178, 29055, 50118, 77114, 58339, 23030, 70359, 10549, 45481, 24965, 31118, 6669]
#USERS = [19528, 16696, 34927, 39890, 37542, 75623, 44217, 69380, 5730, 27099, 7702, 1363, 71304, 21817, 5306, 21931, 62623, 40310, 58680, 55462, 957, 24440, 34386, 33868, 10353, 3095, 19239, 67236, 64255, 55777, 56301, 37214, 30636, 21323, 3037, 3209, 12523, 46239, 2407, 38313, 24126, 1295, 18337, 57884, 38931, 42045, 2956, 43390, 23348, 65114, 60506, 52626, 4435, 10821, 3560, 49777, 6389, 47544, 65031, 76002, 51337, 32026, 58320, 18130, 14850, 46971, 1987, 37259, 1048, 137, 65419, 22248, 74983, 28775, 64805, 39001, 38619, 23198, 35847, 308, 64920, 19775, 5045, 22706, 47808, 15371, 67931, 16112, 17470, 12295, 38784, 46577, 7230, 5611, 13363, 74971, 69628, 44200, 38952, 24748, 53499, 40611, 47253, 6617, 70364, 8826, 45439, 52552, 25398, 24084, 28033, 37392, 8684, 73088, 13219, 29003, 25762, 26838, 30581, 231539, 37069, 71823, 47882, 52406, 49900, 26252, 60435, 24351, 5547, 38066, 29794, 13203]
db = 'philippines'

USERS = [
	162590,
	1417,
	19528,
	214969,
	360392,
	1779875,
	38985,
	503347,
	44938,
	76002,
	979530,
	854388,
	142426,
	37248,
	51991,
	16696,
	34927,
	378532,
	559500,
	39890,
	47756,
	524625,
	219187,
	1799202,
	172061,
	29639,
	618377,
	120249,
	715371,
	250214,
	332178,
	1770269,
	37542,
	120989,
	94081,
	1782896,
	966535,
	820630,
	177015,
	408282,
	904819,
	580469,
	1784020,
	75623,
	114388,
	719424,
	169413,
	44217,
	413978,
	3114,
	1782886,
	1784021,
	69380,
	77109,
	1213994,
	1739231,
	93788,
	1791136,
	1784035,
	1799905,
	1041828,
	314211,
	11126,
	5730,
	339917,
	401102,
	710590,
	524831,
	1043948,
	1010469,
	1686104,
	646083,
	1588874,
	421504,
	205523,
	1792928,
	1544322,
	244754,
	87658,
	440917,
	747516,
	951567,
	1251168,
	1782893,
	27099,
	347491,
	1364517,
	607648,
	167417,
	1443840,
	207581,
	1235724,
	462088,
	1796318,
	1768900,
	525117,
	239546,
	8638,
	92387,
	1800625,
	1800657,
	415250,
	1800667,
	1414919,
	1784026,
	226516,
	178626,
	1800769,
	113972,
	1792927,
	1800776,
	24338,
	116306,
	181135,
	7702,
	87991,
	28269,
	81841,
	461734,
	504056,
	81351,
	236361,
	188930,
	1514872,
	154353,
	121415,
	137772,
	368910,
	1242794,
	403734,
	516654,
	1363,
	1112904,
	473481,
	1772905,
	222199,
	71304,
	21817,
	211162,
	596047,
	507503,
	347295,
	1501513,
	1634734,
	1250263,
	393098,
	158826,
	330773,
	452299,
	563260,
	1161779,
	354284,
	385066,
	230942,
	1145599,
	1801211,
	179778,
	490581,
	1556391,
	1801216,
	469297,
	551536,
	1081635,
	238584,
	616774,
	15942,
	889270,
	316164,
	5306,
	113909,
	1246157,
	577936,
	244073,
	254455,
	167616,
	395457,
	21931,
	76164,
	131561,
	62623,
	40310,
	191979,
	1651578,
	17497,
	1801432,
	1799447,
	321042,
	13409,
	684556,
	58680,
	472702,
	55462,
	957,
	507276,
	557058,
	24440,
	499152,
	260258,
	840522,
	506799,
	1801508,
	95151,
	127401,
	1800418,
	34386,
	33868,
	10353,
	498757,
	1225312,
	1764514,
	1801581,
	5541,
	1611,
	1801675,
	883016,
	1777176,
	109362,
	1801689,
	1801701,
	1738268,
	74746,
	3095,
	83297,
	19239,
	160164,
	67236,
	64255,
	55777,
	1801761,
	350997,
	933797,
	69966,
	231800,
	455161,
	1800855,
	517839,
	77590,
	56301,
	37214,
	545369,
	30636,
	285044,
	21323,
	1756282,
	3037,
	137798,
	1801902,
	534393,
	3209,
	1801934,
	12523,
	416081,
	636004,
	409731,
	751186,
	560867,
	275212,
	1801991,
	46239,
	166264,
	714898,
	2407,
	1790433,
	313192,
	1802046,
	334742,
	378610,
	354984,
	1802131,
	386246,
	357757,
	37553,
	1795120,
	38313,
	525178,
	589288,
	145302,
	1801512,
	1758210,
	4660,
	488377,
	113316,
	85427,
	334075,
	64159,
	1310899,
	24126,
	39504,
	143604,
	274857,
	1295,
	461005,
	18337,
	66387,
	631141,
	1197015,
	1802372,
	57884,
	1632097,
	1802373,
	1802376,
	1802396,
	1802375,
	117689,
	38931,
	602289,
	331608,
	1802415,
	42045,
	1802252,
	1230989,
	449569,
	1754832,
	388774,
	1555726,
	998606,
	2956,
	875675,
	597250,
	43390,
	23348,
	1047238,
	528015,
	65114,
	27741,
	208432,
	899856,
	593205,
	60506,
	695334,
	138488,
	1802378,
	42191,
	334258,
	1060238,
	52626,
	153833,
	95996,
	175882,
	748291,
	1089595,
	1802718,
	1802717,
	1802722,
	1802719,
	4435,
	175523,
	432640,
	1443767,
	10821,
	732626,
	3560,
	933061,
	1802855,
	1802867,
	813207,
	1779802,
	791438,
	812740,
	563947,
	295005,
	349964,
	1302779,
	314635,
	568708,
	49777,
	1341938,
	1803024,
	6389,
	47544,
	171863,
	1777181,
	26139,
	95488,
	65031,
	278506,
	1065211,
	51337,
	32026,
	352368,
	1747365,
	1803111,
	893327,
	330450,
	835140,
	1803188,
	542409,
	92265,
	1761541,
	497015,
	481116,
	1240849,
	58320,
	1803199,
	1803241,
	483666,
	344994,
	374294,
	595035,
	1190883,
	510836,
	716569,
	614447,
	234243,
	1803501,
	951623,
	545197,
	18130,
	149398,
	236945,
	1803572,
	14850,
	277418,
	1803589,
	899308,
	371555,
	1789688,
	46971,
	918387,
	1987,
	37259,
	990473,
	1668080,
	1803680,
	501576,
	1803696,
	1048,
	1803719,
	379381,
	223763,
	274542,
	437598,
	563706,
	600555,
	1802814,
	80994,
	616884,
	1803653,
	500788,
	1803690,
	95972,
	1771851,
	473445,
	137,
	650006,
	1586794,
	1476146,
	1376023,
	1803896,
	145201,
	706229,
	232084,
	1803915,
	814062,
	378484,
	705643,
	272950,
	1803954,
	436419,
	631663,
	65419,
	1803961,
	175605,
	1803888,
	1028719,
	90687,
	1731550,
	1425744,
	1238606,
	372618,
	216097,
	121968,
	104962,
	1804010,
	1299518,
	1803923,
	22248,
	674588,
	131236,
	1804051,
	365944,
	296088,
	1804034,
	4054,
	74983,
	1803992,
	28775,
	64805,
	713803,
	1803801,
	1733620,
	1733621,
	1732634,
	1732633,
	1720930,
	1733616,
	1733454,
	1733488,
	1732481,
	1732580,
	1731695,
	1732681,
	827651,
	1731525,
	1250986,
	39001,
	1733628,
	1733618,
	1804156,
	1804155,
	1804163,
	360183,
	1244086,
	230366,
	38619,
	1804153,
	1727004,
	1804215,
	23198,
	1804083,
	1270905,
	22031,
	570276,
	952041,
	35847,
	1343019,
	1802910,
	1804290,
	1132565,
	1804323,
	826065,
	1803104,
	420303,
	839709,
	844333,
	1803783,
	1803257,
	1747214,
	188518,
	353927,
	212596,
	452826,
	1803907,
	1802931,
	1213353,
	121532,
	115612,
	1804476,
	308,
	781054,
	12448,
	64920,
	1803493,
	1804554,
	27454,
	1228342,
	1726562,
	160967,
	680067,
	1700096,
	1804639,
	754640,
	128873,
	795290,
	750985,
	485426,
	1804702,
	864593,
	19775,
	1804683,
	599429,
	1804538,
	98579,
	1804061,
	120851,
	5045,
	86027,
	1804846,
	428480,
	79885,
	394066,
	1764981,
	996790,
	1342842,
	22706,
	89640,
	47808,
	433575,
	593853,
	15371,
	959665,
	357352,
	1784024,
	67931,
	303028,
	269720,
	157870,
	1737221,
	1805030,
	1805004,
	16112,
	130065,
	1679807,
	646431,
	17470,
	128907,
	1804744,
	12295,
	38784,
	1782222,
	404321,
	106914,
	1804003,
	161951,
	1445105,
	250487,
	125657,
	1805170,
	46577,
	97591,
	7230,
	1805003,
	85314,
	178348,
	223012,
	148776,
	1037758,
	1804735,
	372492,
	135851,
	1805249,
	353787,
	1434766,
	1804430,
	1366100,
	1733245,
	104461,
	1805228,
	512154,
	69930,
	1805291,
	1805278,
	1347259,
	1805287,
	1805279,
	1805281,
	1805274,
	1805280,
	1805292,
	1805286,
	1805294,
	1805293,
	1805299,
	1805285,
	1805288,
	1805297,
	348565,
	1805320,
	1805290,
	1105588,
	474051,
	178186,
	1396789,
	1802811,
	1805372,
	149223,
	5611,
	1804322,
	342402,
	158633,
	1805424,
	1743303,
	1060603,
	129535,
	1759489,
	1805443,
	277005,
	974678,
	1805437,
	1805444,
	178676,
	393906,
	1629425,
	1201445,
	1252306,
	1238227,
	1805715,
	1805736,
	128186,
	382147,
	498848,
	13363,
	1520044,
	420883,
	1763563,
	1805797,
	361003,
	1805721,
	1069655,
	1764383,
	1194244,
	1805731,
	1805866,
	285692,
	655382,
	85478,
	1806004,
	1803672,
	1804447,
	228026,
	475758,
	1805072,
	691714,
	1436154,
	1239580,
	1806141,
	1806059,
	583038,
	617016,
	1806155,
	1804928,
	1806115,
	1806171,
	1799455,
	1806127,
	1436165,
	1805732,
	1806140,
	1806191,
	1784025,
	1740947,
	1784029,
	1805129,
	1806106,
	1806102,
	1806154,
	1806137,
	1806187,
	1782890,
	1231497,
	1806131,
	1806244,
	1806175,
	1436218,
	1806184,
	1806123,
	1806188,
	1805009,
	1806226,
	74971,
	1806165,
	1799461,
	1806158,
	1740946,
	1806197,
	1806027,
	1806162,
	380888,
	289798,
	1806198,
	1806233,
	1806130,
	840570,
	1805806,
	1534637,
	1806230,
	1214485,
	403876,
	1771977,
	1806314,
	540064,
	363016,
	1806350,
	1806359,
	592036,
	677358,
	97547,
	454932,
	1806144,
	183676,
	1806419,
	1768181,
	468963,
	69628,
	1806438,
	152724,
	1806440,
	1545238,
	381276,
	44200,
	189051,
	1806483,
	1711195,
	167945,
	1806192,
	1806514,
	38952,
	1806163,
	161619,
	1806520,
	1806544,
	1239249,
	1806547,
	194751,
	1729058,
	24748,
	340664,
	1806303,
	462384,
	964444,
	1806656,
	1806706,
	1521733,
	1806241,
	1806358,
	1806788,
	1806695,
	1806659,
	1786621,
	243831,
	1806779,
	190690,
	353043,
	461682,
	1806864,
	1051694,
	1806908,
	557365,
	230213,
	53499,
	1806760,
	1806939,
	1806948,
	1806946,
	1807025,
	1807019,
	1807018,
	1807014,
	1807022,
	1807024,
	1807015,
	1807021,
	1807023,
	1807016,
	1807076,
	487141,
	550910,
	719593,
	1287482,
	1799311,
	1799293,
	7630,
	1807178,
	626934,
	1807177,
	1807239,
	1806990,
	729901,
	1807307,
	1807258,
	1806878,
	1806744,
	1807413,
	1807411,
	1807417,
	1807334,
	1803883,
	1807426,
	1806356,
	1807437,
	1807440,
	1807430,
	1784017,
	1807450,
	1806402,
	1807152,
	1232278,
	40611,
	101476,
	90557,
	1803751,
	1743635,
	1807418,
	1803599,
	1806109,
	1806363,
	145099,
	1807046,
	1807292,
	1807548,
	1807360,
	1807458,
	160353,
	364500,
	47253,
	1805664,
	6617,
	196026,
	163738,
	1807692,
	1807739,
	1804133,
	78172,
	1807337,
	1807032,
	70364,
	148841,
	1807792,
	252153,
	1807725,
	1806749,
	1807937,
	8826,
	162049,
	358204,
	110263,
	45439,
	1808049,
	1808045,
	1808119,
	1808093,
	1806373,
	1808141,
	1808177,
	1808132,
	1808135,
	1808144,
	347944,
	1808186,
	1807366,
	483683,
	125038,
	572167,
	1808191,
	1804009,
	52552,
	1808021,
	1808249,
	1808214,
	1808229,
	1808216,
	470845,
	1690860,
	1808256,
	1555208,
	464339,
	78918,
	1808301,
	1808331,
	1807607,
	1808315,
	219668,
	1808248,
	1808288,
	1808311,
	1808291,
	1808236,
	1396066,
	1806104,
	1808346,
	244248,
	189152,
	112410,
	1808317,
	1807620,
	451534,
	1808344,
	873501,
	1808345,
	395416,
	1808410,
	1808409,
	745753,
	701198,
	1808418,
	704762,
	1808312,
	25398,
	1808441,
	1798735,
	1808446,
	360780,
	589596,
	1808447,
	1808295,
	1808443,
	1808464,
	1746818,
	1808471,
	1808469,
	1808442,
	1808448,
	1808440,
	1808459,
	1806574,
	1808479,
	1808473,
	84681,
	1808493,
	1808458,
	1808457,
	549284,
	631658,
	1808507,
	1808497,
	1808503,
	1808478,
	358440,
	1808517,
	1567057,
	1808531,
	1808551,
	24084,
	1808555,
	1808495,
	1808541,
	1808485,
	1545265,
	1803735,
	1808609,
	1808127,
	28033,
	1808607,
	1808600,
	454589,
	1808602,
	37392,
	204045,
	1808691,
	8684,
	752313,
	1807763,
	1808506,
	595246,
	194284,
	733151,
	420742,
	73088,
	505284,
	332704,
	178779,
	20728,
	619933,
	1708578,
	633498,
	1736977,
	1808739,
	251445,
	1808889,
	710310,
	1110616,
	1808422,
	1806212,
	82783,
	1808827,
	685126,
	529836,
	1809010,
	13219,
	1809032,
	1809036,
	1807066,
	1809050,
	1807572,
	317694,
	1807208,
	1806889,
	139043,
	29003,
	1809208,
	4499,
	1563412,
	1808722,
	1805230,
	1718502,
	25762,
	458838,
	98996,
	1158457,
	1809009,
	1809427,
	96974,
	535545,
	1772032,
	26838,
	1809563,
	98140,
	30581,
	162973,
	1807827,
	77476,
	215707,
	1809748,
	1783905,
	1205536,
	1806229,
	1809757,
	318821,
	1809756,
	1809758,
	1809755,
	437495,
	1809764,
	71582,
	121810,
	331548,
	1809754,
	82877,
	1809846,
	579545,
	1808077,
	136303,
	1810068,
	1807580,
	1810128,
	1810131,
	1810160,
	670691,
	1810154,
	1810129,
	1810164,
	1810142,
	1810161,
	1208582,
	1810145,
	1213713,
	1810146,
	1810143,
	1807311,
	1810255,
	1809154,
	1810260,
	1810230,
	1211539,
	1810256,
	125259,
	1810289,
	1810301,
	1809262,
	1810258,
	1810075,
	1810302,
	1810292,
	1810257,
	1810271,
	1804967,
	1810261,
	1810262,
	1809328,
	1810291,
	1810288,
	1810306,
	1810298,
	1803609,
	1810295,
	1810375,
	1810408,
	1806120,
	1810439,
	966268,
	224534,
	214436,
	839302,
	1810573,
	1806070,
	612325,
	1810589,
	1810735,
	870722,
	1806050,
	10557,
	1810756,
	1323363,
	1810998,
	550057,
	416346,
	1811212,
	1807271,
	438811,
	666909,
	1811334,
	261050,
	1811398,
	1811397,
	521264,
	1811430,
	1811492,
	1196567,
	1808431,
	1811553,
	1811560,
	1811566,
	1806073,
	1811555,
	1811562,
	1811563,
	1811576,
	1811558,
	1811569,
	1806122,
	1811570,
	1811556,
	1811564,
	1806456,
	1811705,
	231539,
	355617,
	37069,
	1811848,
	1806308,
	1811850,
	1806457,
	1806166,
	1811873,
	1617449,
	1804150,
	1812113,
	293454,
	1808072,
	84126,
	1812459,
	427562,
	1811444,
	1810358,
	1807169,
	1811893,
	1812620,
	1812677,
	1810457,
	1812667,
	1812693,
	1812683,
	1812676,
	1812670,
	1806453,
	169211,
	1812769,
	1212286,
	1812776,
	1812797,
	1812777,
	1812804,
	1812770,
	1812759,
	1812773,
	1806351,
	1812883,
	1812934,
	1224126,
	1812925,
	1779671,
	1812924,
	1784700,
	1812945,
	1812927,
	1812931,
	1812940,
	1812997,
	1812957,
	1812930,
	1811837,
	1812926,
	1806072,
	1812974,
	355893,
	1811548,
	71823,
	1812594,
	1247357,
	1813297,
	240118,
	1813324,
	1813317,
	1813323,
	323900,
	1811307,
	1813396,
	1806185,
	1809900,
	663232,
	1811363,
	1813830,
	1810869,
	1813831,
	1237243,
	1224148,
	1813833,
	1813835,
	536766,
	1813834,
	13969,
	1159797,
	1813999,
	1813170,
	1814091,
	1814098,
	1814093,
	1814095,
	1814096,
	1814100,
	1814103,
	1814102,
	1814106,
	1226518,
	1814324,
	1814326,
	1814327,
	1814361,
	1814318,
	1814345,
	1814337,
	1814340,
	1814338,
	1814332,
	1801381,
	1814364,
	1814339,
	1814354,
	1814190,
	1814341,
	1814331,
	1814328,
	1814378,
	1814376,
	1814362,
	1814637,
	47882,
	541803,
	1814692,
	1814765,
	1814768,
	1804864,
	1815021,
	1814307,
	1814493,
	1815022,
	219613,
	1281906,
	1814909,
	1812728,
	1815060,
	52406,
	1815117,
	1815155,
	520851,
	1799468,
	1815141,
	1815148,
	1815110,
	1815255,
	1738230,
	1213917,
	1737811,
	1815484,
	1815511,
	1815514,
	1815432,
	1814435,
	462288,
	971,
	1807081,
	1814192,
	1815428,
	579669,
	210173,
	1803526,
	1814826,
	1815550,
	1811107,
	1811112,
	1221851,
	473847,
	1413697,
	49900,
	1815304,
	1815299,
	1815551,
	1807320,
	1810874,
	1815532,
	214968,
	194016,
	1804628,
	1813535,
	1815692,
	1814391,
	1815706,
	1815713,
	1814384,
	1814387,
	1814381,
	1815735,
	360216,
	1814385,
	156528,
	1737812,
	1772093,
	1473223,
	1743907,
	1742920,
	1815943,
	1815956,
	1743859,
	1737272,
	1742250,
	1744228,
	1815958,
	1743914,
	1744554,
	1740822,
	1743418,
	1743308,
	1736986,
	1743956,
	1744581,
	1739097,
	1743980,
	1744525,
	1815957,
	1781234,
	1816037,
	1737042,
	1737184,
	1815989,
	1741393,
	1749599,
	1743959,
	1751194,
	1807908,
	1743958,
	1816087,
	1737104,
	1816029,
	1816076,
	1816082,
	870861,
	1816094,
	1730393,
	1730306,
	109852,
	1809288,
	658406,
	1782895,
	1784034,
	1816433,
	1816437,
	1816434,
	1816436,
	1789620,
	1816451,
	1792536,
	1792665,
	1816479,
	1816435,
	1784022,
	1784030,
	1816552,
	1816729,
	1815553,
	593990,
	501205,
	389325,
	1817130,
	1814304,
	26252,
	1817351,
	597943,
	60435,
	1817303,
	1168918,
	1785045,
	1816142,
	1818406,
	107577,
	1819083,
	1818414,
	1818836,
	191298,
	1819217,
	1815423,
	1805101,
	491515,
	24351,
	1820633,
	619209,
	1577427,
	1821447,
	1224467,
	1002121,
	1821301,
	5547,
	978504,
	1823407,
	630890,
	118203,
	1465197,
	143643,
	1720269,
	1009211,
	1824386,
	1824314,
	38066,
	1437169,
	112975,
	1822133,
	362042,
	1817874,
	1826516,
	451067,
	1535212,
	1380953,
	1777287,
	1828095,
	1828112,
	1828110,
	29794,
	80285,
	1820713,
	1636543,
	1829771,
	1829775,
	1830342,
	1814785,
	1814784,
	1814790,
	1814780,
	1814806,
	1814801,
	1814797,
	1814781,
	1822439,
	1822436,
	1814786,
	1814813,
	1822453,
	1822454,
	1814796,
	1822440,
	1814800,
	1814807,
	1814793,
	1814798,
	1814792,
	1814794,
	1822435,
	1814787,
	1814795,
	1814804,
	1814803,
	1814799,
	1833009,
	869801,
	13203,
	273904
]



mongo_conn = Mongo::MongoClient.new('epic-analytics.cs.colorado.edu','27018')
#mongo_conn = Mongo::MongoClient.new
DB = mongo_conn[db]

def insert_to_mongo(uid, payload)
	DB['users'].update(
		{"uid" => uid}, {'$set' => payload}, 
		opts={:upsert=>true})
end

def parse_date(date_to_parse)
	return Time.new(date_to_parse).utc
end


#Actual Insert Code


def parse_response(response)
	a = {}
	response.children.each do |node|
		unless node.attributes.empty?
			node.children.each do |obj|
				obj.attributes.each do |k,v|
					a[v.name] = v.value
				end
			end
		end
	end
	return a
end

def hit_api(user_id)
	begin
		uri = URI.parse(URI_USERS + user_id)
		response = Net::HTTP.get(uri)
		user_xml = Nokogiri::XML.fragment(response)
		user_h = parse_response(user_xml)
		return user_h
	rescue
		puts "Unsuccessful for user: #{user_id}"
		puts $!
		return false
	end
end

USERS.each_with_index do |user, i|
	h = hit_api(user.to_s) 
	pp h
	insert = {:uid=>h["id"],:name=>h["display_name"],:joiningdate=>Time.parse(h["account_created"]).getutc}

	pp insert
	insert_to_mongo(user, insert)

	puts i
end








